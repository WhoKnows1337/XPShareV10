# XPShare Kategorie & Attribute System

**Version:** 3.1
**Datum:** 2025-10-13
**Status:** Complete System Architecture + Design Decisions Finalized

---

## Ãœbersicht

Das XPShare System nutzt eine **3-stufige Architektur**:

1. **8 Hauptkategorien** (breite Themengebiete)
2. **~48 Unterkategorien** (spezifische PhÃ¤nomene)
3. **Dynamische Attribute** (strukturierte Details wie Form, OberflÃ¤che, Farbe, etc.)

Diese Architektur ermÃ¶glicht:
âœ… Umfassende Abdeckung aller paranormalen/auÃŸergewÃ¶hnlichen Erlebnisse
âœ… PrÃ¤zise Filterung und Suche mit strukturierten Daten
âœ… KI-gestÃ¼tzte Pattern-Analyse und Korrelations-Erkennung
âœ… User-freundliche Navigation (nicht zu breit, nicht zu tief)
âœ… Skalierbarkeit ohne Schema-Ã„nderungen
âœ… Multilanguage Support (EN, DE, FR, ES, IT, etc.)

---

## 1. ğŸ§  BEWUSSTSEIN & INNERES

**Slug:** `consciousness-inner`
**Beschreibung:** Innere Erlebnisse, die das Bewusstsein verÃ¤ndern. Umfasst TrÃ¤ume, Nahtoderfahrungen, psychedelische ZustÃ¤nde, tiefe Meditation und spontane Eingebungen.
**Farbe:** `from-purple-500 to-pink-500`

### Unterkategorien:

| Slug | Name | Emoji | Beschreibung |
|------|------|-------|--------------|
| `dreams` | TrÃ¤ume & Luzide TrÃ¤ume | ğŸŒ™ | NachttrÃ¤ume, KlartrÃ¤ume, wiederkehrende Traummuster |
| `nde` | Nahtoderfahrungen | ğŸ’€ | Near-Death Experiences, Tunnel-Erlebnisse, Jenseits-Begegnungen |
| `obe` | AuÃŸerkÃ¶rperliche Erfahrungen | âœ¨ | Out-of-Body Experiences, Astralreisen, Bewusstsein auÃŸerhalb des KÃ¶rpers |
| `psychedelics` | Psychedelische Erfahrungen | ğŸ„ | DMT, LSD, Psilocybin, Ayahuasca, Mescalin Trips |
| `meditation` | Meditation & Tiefe ZustÃ¤nde | ğŸ§˜ | Transzendentale ZustÃ¤nde, Samadhi, Tiefenmeditation |
| `insights` | Eingebungen & Intuitionen | ğŸ’¡ | PlÃ¶tzliche Erkenntnisse, spontane Ideen, inneres Wissen |

---

## 2. ğŸ›¸ AUSSERIRDISCH & HIMMEL

**Slug:** `extraterrestrial-sky`
**Beschreibung:** PhÃ¤nomene aus dem Weltall und am Himmel. Umfasst UFO/UAP-Sichtungen, Alien-Begegnungen, Himmelslichter, Meteore und atmosphÃ¤rische Anomalien.
**Farbe:** `from-blue-500 to-cyan-500`

### Unterkategorien:

| Slug | Name | Emoji | Beschreibung |
|------|------|-------|--------------|
| `ufo-uap` | UFO/UAP Sichtungen | ğŸ›¸ | Unidentifizierte Flugobjekte, UAP (Unidentified Aerial Phenomena) |
| `alien-contact` | Alien-Begegnungen | ğŸ‘½ | Kontakt mit AuÃŸerirdischen, EntfÃ¼hrungen, Kommunikation |
| `sky-lights` | UnerklÃ¤rliche Himmelslichter | ğŸ’« | MysteriÃ¶se Lichter am Himmel, Orbs, Lichtformationen |
| `meteors` | Meteore & FeuerbÃ¤lle | â˜„ï¸ | Sternschnuppen, FeuerbÃ¤lle, auÃŸergewÃ¶hnliche Meteor-Sichtungen |
| `aurora` | AuÃŸergewÃ¶hnliche Auroras | ğŸŒŒ | Polarlichter an ungewÃ¶hnlichen Orten oder auÃŸergewÃ¶hnlicher IntensitÃ¤t |
| `atmospheric` | AtmosphÃ¤rische Anomalien | â˜ï¸ | Anomale Wolken, Himmelsformationen, unerklÃ¤rliche atmosphÃ¤rische PhÃ¤nomene |

---

## 3. ğŸ‘» WESEN & ERSCHEINUNGEN

**Slug:** `entities-apparitions`
**Beschreibung:** Begegnungen mit Wesen, die nicht in unsere bekannte RealitÃ¤t passen. Umfasst Geister, Schattenwesen, Kryptiden und interdimensionale EntitÃ¤ten.
**Farbe:** `from-gray-700 to-gray-900`

### Unterkategorien:

| Slug | Name | Emoji | Beschreibung |
|------|------|-------|--------------|
| `ghosts` | Geister & Gespenster | ğŸ‘» | Geistererscheinungen, verstorbene Seelen, Spuk |
| `shadow-beings` | Schattenwesen | ğŸŒ‘ | Schattenmenschen, dunkle Figuren, Shadow People |
| `apparitions` | Erscheinungen & Manifestationen | ğŸ’¨ | Visuelle Erscheinungen, Materialisationen, Ektoplasma |
| `cryptids` | Kryptiden | ğŸ¦ | Bigfoot, Nessie, Mothman, unerforschte Kreaturen |
| `poltergeist` | Poltergeist-AktivitÃ¤t | ğŸ“¦ | Bewegte Objekte, KlopfgerÃ¤usche, physische Manifestationen |
| `interdimensional` | Interdimensionale Wesen | ğŸŒ€ | Wesen aus anderen Dimensionen oder RealitÃ¤ten |

---

## 4. ğŸ”® PSI & ÃœBERSINNLICH

**Slug:** `psi-extrasensory`
**Beschreibung:** Ãœbersinnliche mentale FÃ¤higkeiten und ESP (Extrasensory Perception). Umfasst Telepathie, Remote Viewing, Vorahnungen und Psychokinese.
**Farbe:** `from-violet-500 to-purple-600`

### Unterkategorien:

| Slug | Name | Emoji | Beschreibung |
|------|------|-------|--------------|
| `telepathy` | GedankenÃ¼bertragung | ğŸ§  | Telepathische Kommunikation, Gedankenlesen |
| `remote-viewing` | Fernwahrnehmung | ğŸ‘ï¸ | Remote Viewing, Hellsehen Ã¼ber Distanz |
| `precognition` | Vorahnungen & PrÃ¤kognition | ğŸ”® | Zukunftsvisionen, prophetische TrÃ¤ume, Ahnungen die eintraten |
| `clairvoyance` | Hellsehen | ğŸŒŸ | Ãœbersinnliches Sehen, Visionen, Zweites Gesicht |
| `telekinesis` | Psychokinese | ğŸŒ€ | Bewegung von Objekten durch Gedankenkraft, Telekinese |
| `intuition` | Ãœbersinnliche Intuition | ğŸ’­ | BauchgefÃ¼hl mit Ã¼bersinnlicher QualitÃ¤t, Inneres Wissen |

---

## 5. ğŸŒ NATUR & ERDE

**Slug:** `nature-earth`
**Beschreibung:** NatÃ¼rliche PhÃ¤nomene mit unerklÃ¤rbaren Aspekten. Umfasst Erdbeben, Wetteranomalien, geologische Events und anomales Tierverhalten.
**Farbe:** `from-green-600 to-emerald-700`

### Unterkategorien:

| Slug | Name | Emoji | Beschreibung |
|------|------|-------|--------------|
| `earthquakes` | Erdbeben & Vorahnungen | ğŸŒ‹ | Erdbeben, seismische AktivitÃ¤t, Vorahnungen vor Beben |
| `weather` | Extreme WetterphÃ¤nomene | â›ˆï¸ | Anomale StÃ¼rme, unerklÃ¤rliche Wetterlagen, extreme Ereignisse |
| `geological` | Geologische Anomalien | ğŸ”ï¸ | UnerklÃ¤rliche geologische Formationen, Erdverschiebungen |
| `animal-behavior` | Anomales Tierverhalten | ğŸ¦ | Massensterben, unerklÃ¤rliches Verhalten, Tiere mit Vorahnung |
| `environmental` | Umweltanomalien | ğŸŒŠ | UnerklÃ¤rliche UmweltphÃ¤nomene, anomale WasserstÃ¤nde, Klimaanomalien |

---

## 6. ğŸ’« GESUNDHEIT & HEILUNG

**Slug:** `health-healing`
**Beschreibung:** UnerklÃ¤rliche Heilungen und kÃ¶rperliche Anomalien. Umfasst Spontanheilungen, Krebsremissionen, Autoimmunerkrankungen und energetische Heilungen.
**Farbe:** `from-rose-500 to-pink-600`

### Unterkategorien:

| Slug | Name | Emoji | Beschreibung |
|------|------|-------|--------------|
| `spontaneous-healing` | Spontanheilungen | âœ¨ | PlÃ¶tzliche, unerklÃ¤rliche Heilungen ohne medizinische ErklÃ¤rung |
| `cancer-remission` | Krebsremission | ğŸ—ï¸ | UnerklÃ¤rliche Krebsheilungen, Remissionen gegen alle Prognosen |
| `autoimmune` | Autoimmunerkrankungen | ğŸ”¬ | UnerklÃ¤rliche Symptome oder Heilungen bei Autoimmunerkrankungen |
| `energy-healing` | Energetische Heilung | ğŸ™Œ | Heilung durch Energie, Reiki, Handauflegen, Bioenergie |
| `miraculous-recovery` | Wunderheilungen | ğŸŒŸ | Medizinische Wunder, Heilungen die Ã„rzte verblÃ¼ffen |
| `unexplained-symptoms` | UnerklÃ¤rliche Symptome | ğŸ¤” | KÃ¶rperliche Symptome ohne medizinische Ursache, Phantom-Schmerzen |

---

## 7. ğŸ•‰ï¸ SPIRITUELLE PRAXIS

**Slug:** `spiritual-practice`
**Beschreibung:** Erfahrungen durch spirituelle Praktiken und Methoden. Umfasst Yoga, Meditation, Schamanismus, Energiearbeit und Rituale.
**Farbe:** `from-amber-500 to-orange-600`

### Unterkategorien:

| Slug | Name | Emoji | Beschreibung |
|------|------|-------|--------------|
| `yoga` | Yoga-Erfahrungen | ğŸ§˜â€â™€ï¸ | Kundalini-Erwachen, Yoga-induzierte ZustÃ¤nde, Chakra-Aktivierung |
| `meditation-practice` | Meditationspraxis | ğŸ•‰ï¸ | Erfahrungen wÃ¤hrend oder durch regelmÃ¤ÃŸige Meditation |
| `shamanism` | Schamanische Reisen | ğŸª¶ | Schamanische Praktiken, Trommel-Reisen, Pflanzenmedizin-Zeremonien |
| `energy-work` | Energiearbeit | âš¡ | Reiki, Qi Gong, Pranic Healing, Bioenergetik |
| `rituals` | Rituale & Zeremonien | ğŸ•¯ï¸ | Magische Rituale, religiÃ¶se Zeremonien, Manifestations-Praktiken |
| `channeling` | Channeling | ğŸ“¡ | Durchgabe von Botschaften, GeistfÃ¼hrer, mediales Channeling |

---

## 8. â° ZEIT-RAUM & SYNCHRONIZITÃ„T

**Slug:** `time-space-sync`
**Beschreibung:** Anomalien in Zeit, Raum und KausalitÃ¤t. Umfasst Missing Time, DÃ©jÃ -vu, SynchronizitÃ¤t, Reality Glitches und den Mandela-Effekt.
**Farbe:** `from-indigo-600 to-purple-700`

### Unterkategorien:

| Slug | Name | Emoji | Beschreibung |
|------|------|-------|--------------|
| `missing-time` | Fehlende Zeit | â±ï¸ | Missing Time, verlorene Stunden, unerklÃ¤rliche ZeitsprÃ¼nge |
| `time-loops` | Zeitschleifen & DÃ©jÃ -vu | ğŸ”„ | Intensive DÃ©jÃ -vu-Erlebnisse, Zeitschleifen, Wiederholungen |
| `synchronicity` | SynchronizitÃ¤t | ğŸ² | Bedeutungsvolle ZufÃ¤lle, akausale ZusammenhÃ¤nge, Muster |
| `reality-glitches` | RealitÃ¤ts-Glitches | ğŸ‘€ | Matrix-Momente, Glitches in der RealitÃ¤t, Anomalien |
| `dimensional-shift` | Dimensionsverschiebungen | ğŸŒˆ | Erlebnisse in anderen Dimensionen oder ParallelrealitÃ¤ten |
| `mandela-effect` | Mandela-Effekt | ğŸ§© | Kollektiv falsche Erinnerungen, Reality Shifts |

---

# ATTRIBUTE SYSTEM (NEU)

## Konzept

**Problem:** Kategorien alleine sind zu grob. "UFO/UAP" sagt nichts Ã¼ber Form, Farbe, OberflÃ¤che aus.

**LÃ¶sung:** Strukturierte Attribute wie `shape: "triangle"`, `surface: "metallic"`, `light_color: "red"`

### Vorteile

âœ… **PrÃ¤zise Suche:** "Zeig mir alle metallischen Dreiecks-UFOs"
âœ… **Pattern Discovery:** "92% der Triangle-UFOs haben auch Missing Time"
âœ… **Cross-Category:** "Triangle" findet UFOs UND andere dreieckige PhÃ¤nomene
âœ… **Skalierbar:** Neue Attributes ohne DB-Migration
âœ… **KI-freundlich:** Semantic Matching statt hartes Mapping
âœ… **Multilanguage:** Canonical values + Translation Keys

---

## Attribute Schema Beispiele

### UFO/UAP Attributes

| Key | Display Name | Type | Allowed Values |
|-----|--------------|------|----------------|
| `shape` | Form/Shape | enum | triangle, disc, orb, cigar, cylinder, sphere, other |
| `surface` | OberflÃ¤che | enum | metallic, glowing, matte, translucent, reflective |
| `light_color` | Lichtfarbe | enum | red, blue, white, green, orange, yellow, multicolor |
| `light_pattern` | Licht-Muster | enum | steady, pulsating, flashing, rotating |
| `movement` | Bewegung | enum | hovering, fast, erratic, smooth, zigzag, ascending |
| `sound` | GerÃ¤usch | enum | silent, humming, buzzing, roaring, whistling, other |
| `size` | GrÃ¶ÃŸe | enum | tiny, small, medium, large, huge |
| `altitude` | HÃ¶he | enum | ground_level, low, medium, high, very_high |

### Ghost/Entity Attributes

| Key | Display Name | Type | Allowed Values |
|-----|--------------|------|----------------|
| `entity_type` | Art des Wesens | enum | human, shadow, animal, child, elderly, unknown |
| `entity_appearance` | Erscheinung | enum | solid, transparent, shadow, mist, glowing |
| `entity_behavior` | Verhalten | enum | benign, aggressive, playful, sad, angry, confused |
| `interaction` | Interaktion | enum | none, visual, auditory, physical, communication |

### NDE Attributes

| Key | Display Name | Type | Allowed Values |
|-----|--------------|------|----------------|
| `trigger` | AuslÃ¶ser | enum | cardiac_arrest, accident, surgery, drowning, other |
| `features` | Merkmale | enum | tunnel, light, beings, life_review, boundary, choice |
| `aftereffects` | Nachwirkungen | enum | spiritual_change, fearlessness, psychic_abilities |

### Generic Attributes (alle Kategorien)

| Key | Display Name | Type | Allowed Values |
|-----|--------------|------|----------------|
| `intensity` | IntensitÃ¤t | enum | mild, moderate, strong, overwhelming |
| `duration` | Dauer | text | Freitext (z.B. "5 minutes", "2 hours") |
| `emotional_state` | Emotionaler Zustand | enum | peaceful, fearful, joyful, confused, awe, terror |
| `witnesses` | Zeugen | enum | alone, with_1-2, with_3-5, more_than_5 |
| `time_of_day` | Tageszeit | enum | morning, afternoon, evening, night, dawn, dusk |

---

## Database Schema

```sql
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- EBENE 1: KATEGORIEN (Hierarchisch, 2 Levels)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CREATE TABLE question_categories (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  slug text UNIQUE NOT NULL,
  name text NOT NULL,
  description text,
  emoji text,
  color text,                                  -- Tailwind gradient classes
  parent_category_id uuid REFERENCES question_categories(id),
  level integer DEFAULT 0,                     -- 0 = Main, 1 = Sub
  sort_order int NOT NULL DEFAULT 0,
  is_active boolean DEFAULT true,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);

-- Index fÃ¼r Performance
CREATE INDEX idx_categories_parent ON question_categories(parent_category_id);
CREATE INDEX idx_categories_slug ON question_categories(slug);
CREATE INDEX idx_categories_active ON question_categories(is_active) WHERE is_active = true;

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- EBENE 2: ATTRIBUTE SCHEMA (Welche Attributes gibt es?)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CREATE TABLE attribute_schema (
  key text PRIMARY KEY,                        -- "shape", "surface", etc.
  display_name text NOT NULL,                  -- "Form/Shape"
  display_name_de text,                        -- "Form"
  display_name_fr text,                        -- "Forme"
  display_name_es text,                        -- "Forma"
  category_slug text,                          -- "ufo-uap" (optional: nur fÃ¼r diese Kategorie)
  data_type text DEFAULT 'text' CHECK (data_type IN ('text', 'enum', 'number', 'boolean')),
  allowed_values jsonb,                        -- ["triangle", "disc", "orb"] fÃ¼r enums
  description text,
  is_searchable boolean DEFAULT true,
  is_filterable boolean DEFAULT true,
  sort_order int DEFAULT 0,
  created_at timestamptz DEFAULT now()
);

-- Index fÃ¼r schnelle Lookups
CREATE INDEX idx_attr_schema_category ON attribute_schema(category_slug);
CREATE INDEX idx_attr_schema_searchable ON attribute_schema(is_searchable) WHERE is_searchable = true;

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- EBENE 3: DYNAMIC QUESTIONS (Admin-konfigurierbar)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CREATE TABLE dynamic_questions (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  category_id uuid NOT NULL REFERENCES question_categories(id) ON DELETE CASCADE,
  question_text text NOT NULL,
  question_text_de text,                       -- Deutsche Version
  question_text_fr text,                       -- FranzÃ¶sische Version
  question_text_es text,                       -- Spanische Version
  question_type text NOT NULL,                 -- 'chips' | 'text' | 'slider' | 'boolean'
  options jsonb,                               -- ["Triangle", "Disc", "Orb"]
  priority int DEFAULT 0,
  is_optional boolean DEFAULT false,
  help_text text,
  placeholder text,

  -- NEU: Attribute Mapping
  maps_to_attribute text REFERENCES attribute_schema(key),  -- â† WICHTIG!

  tags text[],
  is_active boolean DEFAULT true,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);

-- Indexes
CREATE INDEX idx_questions_category ON dynamic_questions(category_id);
CREATE INDEX idx_questions_active ON dynamic_questions(is_active) WHERE is_active = true;
CREATE INDEX idx_questions_maps_to ON dynamic_questions(maps_to_attribute);

-- Validation: Category muss Questions haben
CREATE OR REPLACE FUNCTION check_category_has_questions()
RETURNS TRIGGER AS $$
BEGIN
  IF NEW.is_active = true AND OLD.is_active = false THEN
    IF NOT EXISTS (
      SELECT 1 FROM dynamic_questions
      WHERE category_id = NEW.id AND is_active = true
    ) THEN
      RAISE EXCEPTION 'Cannot activate category % - no active questions configured', NEW.name;
    END IF;
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER enforce_category_questions
  BEFORE UPDATE ON question_categories
  FOR EACH ROW
  EXECUTE FUNCTION check_category_has_questions();

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- EBENE 4: EXPERIENCE ATTRIBUTES (User-Daten)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CREATE TABLE experience_attributes (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  experience_id uuid NOT NULL REFERENCES experiences(id) ON DELETE CASCADE,
  attribute_key text NOT NULL REFERENCES attribute_schema(key),
  attribute_value text NOT NULL,               -- Immer canonical (lowercase English)
  confidence float CHECK (confidence BETWEEN 0.0 AND 1.0),
  source text DEFAULT 'ai_extracted' CHECK (source IN ('ai_extracted', 'question_answer', 'user_input', 'community_tag')),
  verified_by_user boolean DEFAULT false,
  created_at timestamptz DEFAULT now(),
  created_by uuid REFERENCES auth.users(id)
);

-- Indexes fÃ¼r Performance
CREATE INDEX idx_exp_attr_experience ON experience_attributes(experience_id);
CREATE INDEX idx_exp_attr_key_value ON experience_attributes(attribute_key, attribute_value);
CREATE INDEX idx_exp_attr_key ON experience_attributes(attribute_key);
CREATE INDEX idx_exp_attr_source ON experience_attributes(source);

-- Full-text search fÃ¼r Attribute Values
CREATE INDEX idx_exp_attr_value_fts ON experience_attributes USING gin(to_tsvector('english', attribute_value));

-- RLS Policies
ALTER TABLE experience_attributes ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Public read experience attributes"
  ON experience_attributes FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM experiences e
      WHERE e.id = experience_attributes.experience_id
      AND e.visibility = 'public'
    )
  );

CREATE POLICY "Users can add attributes to own experiences"
  ON experience_attributes FOR INSERT
  WITH CHECK (
    EXISTS (
      SELECT 1 FROM experiences e
      WHERE e.id = experience_attributes.experience_id
      AND e.user_id = auth.uid()
    )
  );

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- EBENE 5: COMMUNITY ATTRIBUTE SUGGESTIONS
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CREATE TABLE attribute_suggestions (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  experience_id uuid NOT NULL REFERENCES experiences(id) ON DELETE CASCADE,
  attribute_key text NOT NULL,
  attribute_value text NOT NULL,
  suggested_by uuid REFERENCES auth.users(id),
  upvotes integer DEFAULT 0,
  downvotes integer DEFAULT 0,
  status text DEFAULT 'pending' CHECK (status IN ('pending', 'approved', 'rejected')),
  reviewed_by uuid REFERENCES auth.users(id),
  created_at timestamptz DEFAULT now(),
  reviewed_at timestamptz
);

CREATE INDEX idx_attr_suggest_exp ON attribute_suggestions(experience_id);
CREATE INDEX idx_attr_suggest_status ON attribute_suggestions(status);
```

---

## Multilanguage Support

### Prinzip: Language-Agnostic Architecture

**DB Storage:** Immer canonical values (lowercase English)
```sql
attribute_value: "triangle"  -- NOT "Dreieck" or "Triangulaire"
```

**AI Detection:** SprachunabhÃ¤ngig durch Semantic Matching
```typescript
User Input (FranzÃ¶sisch): "J'ai vu un objet triangulaire"
AI erkennt: shape = "triangle"

User Input (Deutsch): "Ich sah ein dreieckiges Objekt"
AI erkennt: shape = "triangle"

User Input (Spanisch): "Vi un objeto triangular"
AI erkennt: shape = "triangle"
```

**UI Display:** Translation Keys
```typescript
// messages/de.json
{
  "attributes": {
    "shape": "Form",
    "shape_values": {
      "triangle": "Dreieck",
      "disc": "Scheibe",
      "orb": "Kugel"
    }
  }
}

// messages/fr.json
{
  "attributes": {
    "shape": "Forme",
    "shape_values": {
      "triangle": "Triangle",
      "disc": "Disque",
      "orb": "Orbe"
    }
  }
}
```

### AI Prompt Template (Multilanguage)

```typescript
const prompt = `Analyze this experience and extract structured attributes.

Text Language: ${detectedLanguage}
Text: "${userText}"

Category: ${category}

Extract ONLY these attributes:
${attributeSchema.map(attr =>
  `- ${attr.key}: ${attr.data_type === 'enum' ? attr.allowed_values.join(', ') : attr.data_type}`
).join('\n')}

IMPORTANT:
- Return attribute values in canonical form (lowercase English)
- Example: If user writes "Dreieck" or "triangulaire", return "triangle"
- Use semantic matching, not exact string matching

Return JSON:
{
  "attributes": {
    "shape": {"value": "triangle", "confidence": 0.95},
    "surface": {"value": "metallic", "confidence": 0.88}
  }
}`
```

---

## DESIGN DECISIONS (Finalized 2025-10-13)

### âœ… Question Logic: Option A (Smart Pre-filled System)

**Entscheidung:** Alle Questions fÃ¼r die Kategorie zeigen, mit AI Pre-fills wo verfÃ¼gbar.

**BegrÃ¼ndung:**
- âœ… **Transparenz:** User sieht was AI erkannt hat
- âœ… **Kontrolle:** User kann Fehler korrigieren
- âœ… **Schnell:** "Alle bestÃ¤tigen" Button fÃ¼r 1-Click
- âœ… **Gamification:** XP Bonus fÃ¼r BestÃ¤tigungen
- âœ… **Trust-Building:** User vertraut System mehr durch Sichtbarkeit

**User sieht im Question Flow (Step 3):**
```
âš ï¸ Pflicht-Fragen:
  ğŸ“… Wann genau? [Datum wÃ¤hlen...]
  ğŸ“ Wo warst du? [Ort eingeben...]

âœ¨ KI erkannt (+10 XP fÃ¼r BestÃ¤tigung):
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Form: Triangle âœ“ 95%   [BestÃ¤tigen] â”‚
  â”‚ OberflÃ¤che: Metallic âœ“ 88% [Best.] â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  [âœ“ Alle bestÃ¤tigen] â† 1-Click fÃ¼r alles!

â• Weitere Details? (+5 XP je Antwort) [Aufklappen]
  ğŸ’¡ Wie lange? [dauerte es...]
  ğŸ”Š GerÃ¤usche? [still, summend, ...]
```

**Alternative (abgelehnt):** Option B - Nur Low-Confidence Questions
- âŒ User sieht nicht was AI erkannt hat
- âŒ Weniger Transparenz
- âŒ Keine XP fÃ¼r Pre-filled Fields

### âœ… Attribute Display: ExtractionSidebar Integration

**Wo werden Attributes angezeigt?**
â†’ In der **rechten ExtractionSidebar** (Step 2, nach "Weiter" Klick)

**Wann?**
â†’ Sofort nach AI-Analyse, BEVOR Questions (Step 3)

**Status:** ğŸš§ **Noch nicht implementiert** (geplant fÃ¼r Phase 4)

**Geplante UI in ExtractionSidebar.tsx:**

```tsx
// Nach AI-Analyse in Step 2:
â”Œâ”€ AI Analyse Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ¨ Erkannt:                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“‚ Kategorie: UFO/UAP âœ“ 92%   â”‚
â”‚ ğŸ“ Titel: "Metallisches..."    â”‚
â”‚ ğŸ“ Ort: Berlin âœ“ 88%           â”‚
â”‚ ğŸ“… Datum: [fehlt] âš ï¸           â”‚
â”‚                                 â”‚
â”‚ ğŸ·ï¸ Tags:                       â”‚
â”‚   triangle, metallic, night     â”‚
â”‚                                 â”‚
â”‚ âœ¨ Details (Attributes):        â”‚
â”‚ â”œâ”€ Form: Dreieck 95% [âœï¸]      â”‚
â”‚ â”œâ”€ OberflÃ¤che: Metall 88% [âœï¸] â”‚
â”‚ â”œâ”€ Tageszeit: Nacht 92% [âœï¸]   â”‚
â”‚ â””â”€ Lichter: Rot 85% [âœï¸]       â”‚
â”‚                                 â”‚
â”‚ [Weiter zu Fragen] â†’           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**User Interaction:**
- User kann Attributes DIREKT in Sidebar editieren
- Click auf [âœï¸] Ã¶ffnet Inline-Edit
- Ã„nderungen werden SOFORT in `extractedData.attributes` gespeichert
- Im folgenden Question Flow (Step 3) werden die Sidebar-Werte als Pre-fills verwendet

**Warum KEINE separate Screen 2.5?**
â†’ User hat bereits alles in der Sidebar! Separate Screen wÃ¤re redundant.

### âœ… Attribute Storage: Update on Confirmation

**Wie werden Attributes gespeichert?**

**Szenario 1: AI extrahiert "triangle" (confidence: 0.95)**
```sql
INSERT INTO experience_attributes (attribute_key, attribute_value, confidence, source)
VALUES ('shape', 'triangle', 0.95, 'ai_extracted');
```

**Szenario 2: User bestÃ¤tigt "Triangle" in Question Flow**
```sql
-- Option A: OVERWRITE (gewÃ¤hlt!)
UPDATE experience_attributes
SET confidence = 1.0,
    source = 'user_confirmed',
    verified_by_user = true
WHERE attribute_key = 'shape';

-- Option B: KEEP BOTH (abgelehnt!)
-- WÃ¼rde zu Duplikaten fÃ¼hren
```

**Entscheidung:** Ãœberschreiben! User-BestÃ¤tigung ist wichtiger als AI-Guess.

### âœ… Flow Timing: Keine AI in Step 1

**Wichtig:** AI-Analyse lÃ¤uft NICHT wÃ¤hrend User tippt!

**Step 1 (Canvas):**
- User tippt Text
- Nur Character/Word Count wird angezeigt
- KEINE API Calls, KEINE AI-Analyse
- Kosten: $0

**Step 2 (Nach "Weiter"):**
- User klickt "Weiter â†’"
- POST /api/submit/analyze-complete
- ExtractionSidebar fÃ¼llt sich:
  - Category, Title, Tags
  - **Attributes** (NEU!)
  - Date/Location (wenn erkannt)
- Kosten: ~$0.0005

**Step 3 (Questions):**
- Fragen werden geladen von DB
- AI-Attributes werden als Pre-fills eingefÃ¼gt
- User bestÃ¤tigt oder Ã¤ndert
- Kosten: $0 (nur DB read)

---

## User Flow mit Attributes

### Schritt 1: User schreibt Text (keine AI)

```
User tippt: "Gestern Nacht sah ich ein metallisches Dreieck am Himmel..."

ExtractionSidebar zeigt nur:
- Zeichen: 280
- WÃ¶rter: 42
- âœ… Bereit fÃ¼r Analyse

Keine API Calls! Kosten: $0
```

### Schritt 2: Nach "Weiter" â†’ Komplette AI-Analyse

```typescript
POST /api/submit/analyze-complete
{
  text: "Gestern Nacht sah ich ein metallisches Dreieck..."
}

Response:
{
  category: "extraterrestrial-sky",
  subcategory: "ufo-uap",
  title: "Metallisches Dreieck am Himmel",
  summary: "Sichtung eines dreieckigen UFOs mit metallischer OberflÃ¤che...",
  tags: ["triangle", "metallic", "night", "berlin"],
  attributes: {
    shape: { value: "triangle", confidence: 0.95, evidence: "dreieckiges" },
    surface: { value: "metallic", confidence: 0.88, evidence: "metallisch" },
    time_of_day: { value: "night", confidence: 0.92, evidence: "Nacht" }
  },
  missing_info: ["date", "exact_location", "duration"]
}

Kosten: ~$0.0005 (eine AI-Anfrage!)
Zeit: ~2 Sekunden
```

### Schritt 3: Intelligente Fragen mit Pre-fills

```typescript
GET /api/questions?category=ufo-uap

Response (merged mit AI-Attributes):
[
  {
    id: "q1",
    question: "Wann genau?",
    type: "date",
    required: true,
    maps_to_attribute: null
  },
  {
    id: "q2",
    question: "Welche Form hatte das Objekt?",
    type: "chips",
    options: ["Triangle", "Disc", "Orb", "Cigar"],
    maps_to_attribute: "shape",
    prefilled_value: "Triangle",  // â† Von AI!
    prefilled_confidence: 0.95,
    required: false,
    xp_bonus: 5
  },
  {
    id: "q3",
    question: "Wie war die OberflÃ¤che?",
    type: "chips",
    options: ["Metallic", "Glowing", "Matte"],
    maps_to_attribute: "surface",
    prefilled_value: "Metallic",  // â† Von AI!
    prefilled_confidence: 0.88,
    required: false
  }
]

User klickt "BestÃ¤tigen" bei Pre-fills:
â†’ 1 Click = Frage beantwortet!
â†’ Attribute wird zu confidence: 1.0, source: "user_confirmed"
```

### Schritt 4: Text Enrichment

```typescript
POST /api/submit/enrich-text
{
  original_text: "Gestern Nacht sah ich...",
  answers: {
    q1: "15. Oktober 2024, 22:30",
    q2: "Triangle",
    q3: "Metallic"
  }
}

Response:
{
  enriched_text: "Am 15. Oktober 2024 gegen 22:30 Uhr sah ich ein
  metallisches, dreieckiges Objekt am Himmel Ã¼ber Berlin..."
}

Kosten: ~$0.0004
Zeit: ~1.5s
```

### Schritt 5: Speichern

```typescript
POST /api/submit/publish
{
  original_text: "...",
  enriched_text: "...",
  title: "...",
  summary: "...",
  category: "ufo-uap",
  attributes: {
    shape: { value: "triangle", confidence: 1.0, source: "user_confirmed" },
    surface: { value: "metallic", confidence: 1.0, source: "user_confirmed" },
    time_of_day: { value: "night", confidence: 0.92, source: "ai_extracted" }
  }
}

Backend speichert:
1. experiences table (original_text + enriched_text)
2. experience_attributes table (3 rows)
3. Generate embedding (text-embedding-3-large)

Kosten: ~$0.00026 (Embedding)
Zeit: ~0.5s
```

### Schritt 6: Pattern Matching (async, Background)

```typescript
POST /api/patterns/analyze { experienceId: "..." }

Background Job:
1. Find similar by attributes:
   - shape=triangle â†’ 89 other experiences
   - 82 have "missing-time" category (92%!)

2. Geographic clusters:
   - 12 triangle sightings in Berlin

3. Temporal patterns:
   - 23 triangle sightings in Oktober 2024

4. Co-occurrence analysis:
   - triangle + metallic: 73%
   - triangle + silent: 91%

Speichert Insights fÃ¼r Experience Detail Page
```

---

## Pattern Discovery mit Attributes

### SQL Queries fÃ¼r Pattern Analysis

```sql
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- 1. CROSS-ATTRIBUTE CORRELATION
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- "Wie viele Triangle UFOs haben auch Missing Time?"
WITH triangle_ufos AS (
  SELECT DISTINCT e.id, e.user_id
  FROM experiences e
  JOIN experience_attributes ea ON e.id = ea.experience_id
  WHERE ea.attribute_key = 'shape'
    AND ea.attribute_value = 'triangle'
    AND e.category = 'ufo-uap'
),
missing_time_experiences AS (
  SELECT DISTINCT user_id
  FROM experiences
  WHERE category IN ('missing-time', 'time-space-sync')
)
SELECT
  COUNT(DISTINCT t.id) as total_triangle_ufos,
  COUNT(DISTINCT CASE WHEN m.user_id IS NOT NULL THEN t.user_id END) as with_missing_time,
  ROUND(
    COUNT(DISTINCT CASE WHEN m.user_id IS NOT NULL THEN t.user_id END)::float /
    COUNT(DISTINCT t.id) * 100
  ) as percentage
FROM triangle_ufos t
LEFT JOIN missing_time_experiences m ON t.user_id = m.user_id;

-- Ergebnis: 92% Korrelation!

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- 2. GEOGRAPHIC CLUSTERING
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- "Wo gibt es Triangle-Hotspots?"
SELECT
  location_text,
  COUNT(*) as sighting_count,
  AVG(location_lat) as center_lat,
  AVG(location_lng) as center_lng
FROM experiences e
JOIN experience_attributes ea ON e.id = ea.experience_id
WHERE ea.attribute_key = 'shape'
  AND ea.attribute_value = 'triangle'
  AND e.location_lat IS NOT NULL
GROUP BY location_text
HAVING COUNT(*) >= 3
ORDER BY COUNT(*) DESC;

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- 3. TEMPORAL PATTERNS
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- "Wann hÃ¤ufen sich Triangle-Sightings?"
SELECT
  date_trunc('month', date_occurred) as month,
  COUNT(*) as sightings
FROM experiences e
JOIN experience_attributes ea ON e.id = ea.experience_id
WHERE ea.attribute_key = 'shape'
  AND ea.attribute_value = 'triangle'
  AND date_occurred IS NOT NULL
GROUP BY date_trunc('month', date_occurred)
ORDER BY COUNT(*) DESC
LIMIT 10;

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- 4. CO-OCCURRENCE ANALYSIS
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- "Welche Attributes treten zusammen mit Triangle auf?"
WITH triangle_experiences AS (
  SELECT experience_id
  FROM experience_attributes
  WHERE attribute_key = 'shape'
    AND attribute_value = 'triangle'
)
SELECT
  ea.attribute_key,
  ea.attribute_value,
  COUNT(*) as occurrences,
  ROUND(
    COUNT(*)::float / (SELECT COUNT(*) FROM triangle_experiences) * 100
  ) as percentage
FROM experience_attributes ea
JOIN triangle_experiences te ON ea.experience_id = te.experience_id
WHERE ea.attribute_key != 'shape'
GROUP BY ea.attribute_key, ea.attribute_value
HAVING COUNT(*) >= 10
ORDER BY COUNT(*) DESC;

-- Ergebnis:
-- silent: 91%
-- metallic: 73%
-- night: 67%
-- hovering: 58%
```

---

## Admin Interface

### 1. Attribute Schema Editor

```
Route: /admin/attributes

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Attribute Schema Verwalten                    [+ Neu]       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚ Filter: [Alle Kategorien â–¼] [Nur Enum â–¼]                   â”‚
â”‚                                                              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Key      â”‚ Name       â”‚ Typ      â”‚ Kategorie  â”‚ Aktion â”‚ â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚ â”‚ shape    â”‚ Form       â”‚ enum     â”‚ ufo-uap    â”‚ [Edit] â”‚ â”‚
â”‚ â”‚ surface  â”‚ OberflÃ¤che â”‚ enum     â”‚ ufo-uap    â”‚ [Edit] â”‚ â”‚
â”‚ â”‚ movement â”‚ Bewegung   â”‚ enum     â”‚ ufo-uap    â”‚ [Edit] â”‚ â”‚
â”‚ â”‚ sound    â”‚ GerÃ¤usch   â”‚ enum     â”‚ ufo-uap    â”‚ [Edit] â”‚ â”‚
â”‚ â”‚ duration â”‚ Dauer      â”‚ text     â”‚ (alle)     â”‚ [Edit] â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                              â”‚
â”‚ ğŸ“Š Total: 23 Attributes                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[Click + Neu]:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Neues Attribut erstellen                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Key (technisch): [altitude                              ]   â”‚
â”‚                   â„¹ï¸ Nur lowercase, keine Leerzeichen       â”‚
â”‚                                                              â”‚
â”‚ Display Name (EN): [Altitude                             ]  â”‚
â”‚ Display Name (DE): [HÃ¶he                                 ]  â”‚
â”‚ Display Name (FR): [Altitude                             ]  â”‚
â”‚ Display Name (ES): [Altitud                              ]  â”‚
â”‚                                                              â”‚
â”‚ Kategorie:        [ufo-uap â–¼]                               â”‚
â”‚                   â„¹ï¸ Optional: Nur fÃ¼r diese Kategorie      â”‚
â”‚                                                              â”‚
â”‚ Datentyp:         [â— Enum  â—‹ Text  â—‹ Number]                â”‚
â”‚                                                              â”‚
â”‚ Erlaubte Werte (fÃ¼r Enum):                                  â”‚
â”‚ [ground_level    ] [Ã—]                                      â”‚
â”‚ [low             ] [Ã—]                                      â”‚
â”‚ [medium          ] [Ã—]                                      â”‚
â”‚ [high            ] [Ã—]                                      â”‚
â”‚ [+ Wert hinzufÃ¼gen]                                         â”‚
â”‚                                                              â”‚
â”‚ â˜‘ Durchsuchbar                                              â”‚
â”‚ â˜‘ Filterbar                                                 â”‚
â”‚                                                              â”‚
â”‚ [Speichern] [Abbrechen]                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. Question Editor mit Attribute Mapping

```
Route: /admin/questions?category=ufo-uap

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Fragen fÃ¼r: UFO/UAP Sichtungen               [+ Neu]       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚ [Drag] Frage 1: "Wann genau?"                              â”‚
â”‚        Typ: Date | Pflicht | Maps to: (none)               â”‚
â”‚        [Edit] [Delete] [Duplicate]                          â”‚
â”‚                                                              â”‚
â”‚ [Drag] Frage 2: "Welche Form hatte das Objekt?"            â”‚
â”‚        Typ: Chips | Optional | Maps to: shape âœ“            â”‚
â”‚        [Edit] [Delete] [Duplicate]                          â”‚
â”‚                                                              â”‚
â”‚ [Drag] Frage 3: "Wie war die OberflÃ¤che?"                  â”‚
â”‚        Typ: Chips | Optional | Maps to: surface âœ“          â”‚
â”‚        [Edit] [Delete] [Duplicate]                          â”‚
â”‚                                                              â”‚
â”‚ ğŸ’¡ Template anwenden: [UAP Standard â–¼] [Anwenden]          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[Click Edit auf Frage 2]:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frage bearbeiten                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Fragentext (DE): [Welche Form hatte das Objekt?         ]  â”‚
â”‚ Fragentext (EN): [What shape was the object?            ]  â”‚
â”‚ Fragentext (FR): [Quelle forme avait l'objet?           ]  â”‚
â”‚                                                              â”‚
â”‚ Fragetyp: [Chips (Multiple Choice) â–¼]                      â”‚
â”‚                                                              â”‚
â”‚ Optionen:                                                   â”‚
â”‚ [Triangle        ] [Ã—]                                      â”‚
â”‚ [Disc            ] [Ã—]                                      â”‚
â”‚ [Orb             ] [Ã—]                                      â”‚
â”‚ [Cigar           ] [Ã—]                                      â”‚
â”‚ [+ Option hinzufÃ¼gen]                                       â”‚
â”‚                                                              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ğŸ”— ATTRIBUTE MAPPING                                   â”‚ â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚ â”‚ Maps to Attribute: [shape â–¼]                           â”‚ â”‚
â”‚ â”‚                                                         â”‚ â”‚
â”‚ â”‚ â˜‘ Pre-fill von AI wenn verfÃ¼gbar                      â”‚ â”‚
â”‚ â”‚ â˜‘ Antwort als Attribute speichern                     â”‚ â”‚
â”‚ â”‚                                                         â”‚ â”‚
â”‚ â”‚ Value Mapping (auto: lowercase):                       â”‚ â”‚
â”‚ â”‚ Option "Triangle" â†’ [triangle    ]                     â”‚ â”‚
â”‚ â”‚ Option "Disc"     â†’ [disc        ]                     â”‚ â”‚
â”‚ â”‚ Option "Orb"      â†’ [orb         ]                     â”‚ â”‚
â”‚ â”‚                                                         â”‚ â”‚
â”‚ â”‚ â„¹ï¸ AI mapped semantisch: "Dreieck" â†’ "triangle"        â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                              â”‚
â”‚ â˜ Pflichtfrage                                              â”‚
â”‚ â˜‘ Optional (+5 XP Bonus)                                   â”‚
â”‚                                                              â”‚
â”‚ [Speichern] [Abbrechen]                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. Category Management mit Status

```
Route: /admin/categories

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Kategorien Verwalten                          [+ Neu]       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚ ğŸ›¸ AuÃŸerirdisch & Himmel                                    â”‚
â”‚ â”œâ”€ UFO/UAP Sichtungen                                       â”‚
â”‚ â”‚  âœ“ 8 Questions | âœ“ 8 Attributes | [Edit] [View]         â”‚
â”‚ â”œâ”€ Alien-Begegnungen                                        â”‚
â”‚ â”‚  âœ“ 6 Questions | âœ“ 5 Attributes | [Edit] [View]         â”‚
â”‚ â””â”€ Himmelslichter                                           â”‚
â”‚    âš ï¸ 2 Questions | âœ“ 4 Attributes | [Edit] [View]         â”‚
â”‚    â””â”€ Warning: Needs at least 5 questions before activationâ”‚
â”‚                                                              â”‚
â”‚ ğŸ‘» Wesen & Erscheinungen                                    â”‚
â”‚ â”œâ”€ Geister & Gespenster                                     â”‚
â”‚ â”‚  âœ“ 7 Questions | âœ“ 6 Attributes | [Edit] [View]         â”‚
â”‚ â””â”€ Schattenwesen                                            â”‚
â”‚    âŒ 0 Questions | âœ“ 3 Attributes | [Setup Required]      â”‚
â”‚    â””â”€ [ğŸ“‹ Use Template] [â• Create Questions]               â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## API Endpoints

```typescript
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CATEGORIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

GET  /api/categories                   // Alle Kategorien mit Hierarchie
GET  /api/categories?level=0           // Nur Hauptkategorien
GET  /api/categories?parent_id={uuid}  // Unterkategorien
GET  /api/categories/{slug}            // Single Category mit Stats

POST   /api/admin/categories           // Neue Kategorie
PATCH  /api/admin/categories/{id}      // Update
DELETE /api/admin/categories/{id}      // Delete (nur wenn keine Experiences)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ATTRIBUTES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

GET  /api/attributes                   // Alle Attribute Schema
GET  /api/attributes?category={slug}   // Filtered by Category
GET  /api/attributes/{key}             // Single Attribute

GET  /api/attributes/available         // Available Attributes with Counts
     ?category=ufo-uap                 // Filter by Category

Response:
{
  "shape": {
    "values": ["triangle", "disc", "orb"],
    "counts": { "triangle": 89, "disc": 67, "orb": 45 },
    "display_names": {
      "de": {"triangle": "Dreieck", "disc": "Scheibe"},
      "fr": {"triangle": "Triangle", "disc": "Disque"}
    }
  }
}

POST   /api/admin/attributes           // Create Attribute Schema
PATCH  /api/admin/attributes/{key}     // Update
DELETE /api/admin/attributes/{key}     // Delete

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// QUESTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

GET  /api/questions?category={slug}    // Questions fÃ¼r Kategorie (merged mit AI)

Response:
[
  {
    id: "q1",
    question: "Welche Form?",
    type: "chips",
    options: ["Triangle", "Disc", "Orb"],
    maps_to_attribute: "shape",
    prefilled_value: "Triangle",        // â† Von AI
    prefilled_confidence: 0.95,
    required: false,
    xp_bonus: 5
  }
]

POST   /api/admin/questions            // Create Question
PATCH  /api/admin/questions/{id}       // Update
DELETE /api/admin/questions/{id}       // Delete
POST   /api/admin/questions/reorder    // Reorder Priority

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SUBMIT FLOW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

POST /api/submit/analyze-complete      // Komplette AI-Analyse
Request:
{
  text: "User's experience text",
  language: "de"  // Optional, auto-detected
}

Response:
{
  category: "extraterrestrial-sky",
  subcategory: "ufo-uap",
  title: "...",
  summary: "...",
  tags: ["triangle", "metallic"],
  attributes: {
    shape: { value: "triangle", confidence: 0.95, evidence: "..." },
    surface: { value: "metallic", confidence: 0.88, evidence: "..." }
  },
  missing_info: ["date", "location"]
}

POST /api/submit/enrich-text           // Text Enrichment
Request:
{
  original_text: "...",
  answers: { q1: "...", q2: "..." }
}

Response:
{
  enriched_text: "Erweiterte Version mit integrierten Antworten..."
}

POST /api/submit/publish               // Publish Experience
Request:
{
  original_text: "...",
  enriched_text: "...",
  title: "...",
  summary: "...",
  category: "ufo-uap",
  attributes: {
    shape: { value: "triangle", confidence: 1.0, source: "user_confirmed" }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SEARCH & FILTER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

GET /api/experiences?category=ufo-uap&shape=triangle&surface=metallic
    â†’ Attribute-based filtering

GET /api/experiences/search?q=triangle+metallic+berlin
    â†’ Full-text + Attribute + Vector search

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PATTERN MATCHING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

POST /api/patterns/analyze             // Trigger Pattern Analysis (async)
Request: { experienceId: "..." }

GET /api/patterns/for-experience/{id}  // Get Pattern Insights
Response:
{
  correlations: {
    "triangle_missing_time": {
      "strength": 0.92,
      "description": "92% of triangle UFOs report missing time"
    }
  },
  geographic: [...],
  temporal: [...],
  coOccurrence: [...]
}
```

---

## Kosten & Performance

### Embedding Model: text-embedding-3-large

**Warum large statt small?**

| Metric | small | large |
|--------|-------|-------|
| Dimensions | 1536 | 3072 |
| Cost per 1M tokens | $0.020 | $0.130 |
| Multilanguage Accuracy | 82% | 94% (+12%) |
| Semantic Matching | Good | Excellent |

**Kosten pro Experience:**

```
Submission Flow:
- AI Analyse (analyze-complete):     $0.0005
- Text Enrichment:                    $0.0004
- Embedding (large, ~2000 tokens):    $0.00026
- TOTAL per Submission:               $0.00116

Bei 10,000 Submissions/Monat:        ~$12/month

ZusÃ¤tzlich Pattern Matching:
- Background Job (1x pro Experience): $0.0002
- TOTAL mit Pattern Matching:         $0.00136
- Bei 10,000 Submissions/Monat:       ~$14/month

âœ… TOTAL COST: ~$14/month bei 10k Submissions
```

**Performance:**

```
User Experience Timing:
- Schritt 1 (Schreiben):       0s (keine AI)
- Schritt 2 (Analyse):         ~2s (AI Call)
- Schritt 3 (Questions):       User-Zeit (~2 Min)
- Schritt 4 (Enrichment):      ~1.5s (AI Call)
- Schritt 5 (Embedding):       ~0.5s
- TOTAL AI-Zeit:               ~4s
- TOTAL User-Zeit:             ~2-3 Min

Pattern Matching:
- Background, non-blocking
- ~3-5s processing time
- Ergebnisse erscheinen nachtrÃ¤glich
```

---

## GelÃ¶ste Probleme

### Problem 1: Categories ohne Questions âœ…

**LÃ¶sung:**
- DB Trigger verhindert Aktivierung ohne Questions
- Admin UI zeigt Warning: "âš ï¸ 0 Questions - Setup Required"
- Template System: "Use Template" Button
- Fallback: Generic Questions wenn Category neu

### Problem 2: Value Mapping mit verschiedenen Sprachen âœ…

**LÃ¶sung:**
- Canonical Values in DB (immer lowercase English)
- AI Semantic Matching: "Dreieck" â†’ "triangle"
- Fuzzy Matching fÃ¼r Tippfehler: "triangel" â†’ "triangle"
- UI Translation Keys fÃ¼r Display

### Problem 3: AI Halluzinationen âœ…

**LÃ¶sung:**
```typescript
// Backend Validation
if (attr.data_type === 'enum') {
  if (!attr.allowed_values.includes(extracted.value)) {
    // Try fuzzy matching first
    const match = fuzzyMatch(extracted.value, attr.allowed_values)
    if (match.score > 0.8) {
      extracted.value = match.value
    } else {
      // Fallback to "other"
      extracted.value = 'other'
      extracted.confidence = 0.5
      // Create suggestion for admin review
      await createAttributeSuggestion(extracted.value, experienceId)
    }
  }
}
```

### Problem 4: Leeres System / Initial Setup âœ…

**LÃ¶sung:**
- Seed Script mit allen 48 Kategorien
- Pre-defined Attribute Schema fÃ¼r jede Kategorie
- Question Templates fÃ¼r schnelles Setup
- Migration NICHT nÃ¶tig (new system)

---

## Migration Strategy

### FÃ¼r neue Deployments (Current)

**Schritt 1: Database Setup**
```bash
# Run migrations
supabase migration up

# Seed Categories (8 Main + 48 Sub)
npm run db:seed:categories

# Seed Attribute Schema (~50 Attributes)
npm run db:seed:attributes

# Seed Question Templates
npm run db:seed:question-templates
```

**Schritt 2: Admin Setup**
```
1. Login als Admin
2. Go to /admin/categories
3. Review seeded categories
4. FÃ¼r jede Kategorie:
   - [Use Template] fÃ¼r Standard-Questions
   - Oder [Create Questions] manuell
5. Review Attribute Schema in /admin/attributes
6. Activate Categories when ready
```

**Schritt 3: Test**
```
1. Create Test Experience in jeder Kategorie
2. Verify AI Attribute Extraction
3. Verify Question Pre-fills
4. Verify Pattern Matching
5. Test Multilanguage (DE, FR, ES)
```

### FÃ¼r bestehende Experiences (Backfill)

```typescript
// Background Job: Attribute Extraction fÃ¼r alte Experiences

async function migrateOldExperiences() {
  const experiences = await getExperiencesWithoutAttributes()

  for (const exp of experiences) {
    try {
      // Detect category if not set
      if (!exp.category) {
        const category = await detectCategory(exp.story_text)
        await updateExperienceCategory(exp.id, category)
      }

      // Load attribute schema for category
      const attributeSchema = await getAttributeSchemaForCategory(exp.category)

      // AI extracts attributes from story_text
      const attributes = await extractAttributes(
        exp.story_text,
        exp.category,
        attributeSchema
      )

      // Save attributes
      await saveAttributes(exp.id, attributes)

      console.log(`âœ“ Migrated ${exp.id}`)
    } catch (error) {
      console.error(`âœ— Failed ${exp.id}:`, error)
    }
  }
}

// Kosten: 5000 experiences Ã— $0.0003 = $1.50 (akzeptabel!)
```

---

## NÃ¤chste Schritte

### Phase 1: Database & Seed (2h)
1. âœ… Dokumentation (diese Datei)
2. â³ Migrations erstellen:
   - `attribute_schema` table
   - `experience_attributes` table
   - `attribute_suggestions` table
   - `dynamic_questions.maps_to_attribute` column
3. â³ Seed Scripts:
   - 48 Kategorien (mit emoji, color, parent_id)
   - ~50 Attribute Schema Entries
   - Question Templates fÃ¼r jede Kategorie
4. â³ Validation Triggers & Functions

### Phase 2: Backend APIs (3h)
5. â³ `/api/submit/analyze-complete` - Enhanced mit Attributes
6. â³ `/api/submit/enrich-text` - Text Enrichment
7. â³ `/api/questions?category=X` - Mit Pre-fills
8. â³ `/api/attributes/*` - CRUD fÃ¼r Attribute Schema
9. â³ `/api/admin/questions/*` - Enhanced mit Mapping

### Phase 3: Admin Interface (2h)
10. â³ Attribute Schema Editor `/admin/attributes`
11. â³ Question Editor Enhanced (Attribute Mapping UI)
12. â³ Category Status Display (Question/Attribute Count)
13. â³ Template System UI

### Phase 4: User Flow (5h)
14. â³ **ExtractionSidebar Enhancement** (Attributes Display) - 1.5h
    - Extend `submitStore.extractedData` mit `attributes: Record<string, ExtractedField>`
    - Update ExtractionSidebar.tsx:
      - Neue Section "âœ¨ Details" nach Tags
      - `ExtractionField` component fÃ¼r jedes Attribute
      - Inline-Edit mit [âœï¸] Button
      - Translation Keys fÃ¼r Attribute Keys/Values (DE/FR/ES)
    - Responsive Design (gleicher Stil wie Category/Title/Tags)
15. â³ **API /api/submit/analyze-complete** - Enhanced mit Attributes - 1h
    - AI extrahiert Attributes basierend auf Category
    - Returns: `{ attributes: { shape: {value, confidence, evidence} } }`
    - Semantic Matching fÃ¼r Multilanguage
    - Validation gegen `attribute_schema` table
16. â³ **Question Flow mit Pre-fills** (Option A) - 1.5h
    - `confidenceChecker.ts`: Update `generateQuestions()` zu Option A Logic
    - Alle Questions zeigen, nicht nur low-confidence
    - Pre-fill von `extractedData.attributes`
    - UI: "âœ¨ KI erkannt" Badge + Confidence %
    - "Alle bestÃ¤tigen" Button
17. â³ **Text Enrichment Integration** - 0.5h
    - Existing EnrichedTextEditor.tsx works already
    - Only API call needed
18. â³ **Publish mit Attribute Storage** - 0.5h
    - Save to `experience_attributes` table
    - Update (not insert) wenn User bestÃ¤tigt
    - `source: 'user_confirmed', confidence: 1.0`

### Phase 5: Search & Pattern (3h)
19. â³ Attribute-based Search/Filter UI
20. â³ Pattern Discovery Functions (SQL)
21. â³ Pattern Insights Component
22. â³ Similar Experiences mit Attribute Matching

### Phase 6: Multilanguage & Polish (2h)
23. â³ Translation Keys fÃ¼r Attributes
24. â³ AI Prompt Templates (EN/DE/FR/ES)
25. â³ Language Switching Tests
26. â³ Migration: Embedding â†’ large Model

---

## Testing Checklist

### Unit Tests
- [ ] Attribute Validation (enum values)
- [ ] Fuzzy Matching (Tippfehler)
- [ ] Semantic Mapping ("Dreieck" â†’ "triangle")
- [ ] Question Pre-fill Logic
- [ ] Text Enrichment Quality

### Integration Tests
- [ ] Submit Flow End-to-End
- [ ] Admin CRUD Operations
- [ ] Pattern Discovery Queries
- [ ] Multilanguage Support (DE, FR, ES, IT)
- [ ] Search & Filter mit Attributes

### Performance Tests
- [ ] AI Response Time (<3s)
- [ ] Embedding Generation (<1s)
- [ ] Pattern Matching (<5s)
- [ ] Search mit Attribute Filters (<500ms)
- [ ] Admin UI Load Time (<2s)

---

**Autor:** Claude + Tom
**Version:** 3.1 - Complete System Architecture + Design Decisions Finalized
**Status:** Ready for Implementation
**Letzte Ã„nderung:** 2025-10-13 - Design Decisions (Option A, Sidebar Integration)
**Review:** Pending
**Freigabe:** Pending
